defaults: &defaults
  working_directory: ~/repo
version: 2
jobs:
  build:
    <<: *defaults
    docker:
      - image: circleci/ruby:2.5.3
    steps:
      - checkout
      - run:
          name: Install Builder
          command : |
            gem install bundler            
      - run: 
          name: Link Bundle Path
          command : |
            bundle --path vendor/bundle
      - run:
          name: Precompile Assets
          command: bundle exec jekyll build
      - persist_to_workspace:
          root: ./
          paths:
            - _site/
  deploy:
    <<: *defaults
    docker:
      - image: circleci/python:3.6.3
    steps:
      - checkout
      - run:
          name: Switch to Prod branch
          command: git checkout prod
      - run:
          name: Where am I
          command: pwd
      - attach_workspace:
          at: ./
      - run:
          name: Copy attached work space to home directory
          command: cp -a _site/. /home/circleci/repo/
      - run:
          name: Remove _site folder
          command: rm -R _site
      - run:
          name: Git Add and Deploy
          command: |
              git config user.name "$GITHUB_USERNAME"
              git config user.email "$GITHUB_EMAIL"
              git add *
              git commit --allow-empty -m "Page release ${CIRCLE_BUILD_NUM} from ${CIRCLE_BRANCH}"
              git push --force origin prod
              
workflows:
  version: 2
  test-deploy:
    jobs:
      - build:
          branches:
            ignore:
              - prod
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
